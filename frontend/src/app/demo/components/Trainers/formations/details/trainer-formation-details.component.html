<div class="grid" *ngIf="!loading && formation">
    <!-- Header -->
    <div class="col-12">
        <div class="card">
            <div class="flex justify-content-between align-items-center">
                <div class="flex align-items-center gap-3">
                    <p-button 
                        icon="pi pi-arrow-left" 
                        class="p-button-rounded p-button-text"
                        (click)="goBack()">
                    </p-button>
                    <div>
                        <h2 class="text-900 font-semibold mb-1">{{ formation.name }}</h2>
                        <p class="text-600 m-0">Formation Details</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <p-button 
                        *ngIf="!editMode"
                        icon="pi pi-pencil" 
                        label="Edit" 
                        class="p-button-outlined"
                        (click)="toggleEditMode()">
                    </p-button>
                    <p-button 
                        *ngIf="editMode"
                        icon="pi pi-check" 
                        label="Save" 
                        (click)="saveChanges()">
                    </p-button>
                    <p-button 
                        *ngIf="editMode"
                        icon="pi pi-times" 
                        label="Cancel" 
                        class="p-button-outlined"
                        (click)="toggleEditMode()">
                    </p-button>
                </div>
            </div>
        </div>
    </div>

    <!-- Formation Details -->
    <div class="col-12 lg:col-8">
        <div class="card">
            <h5>Formation Information</h5>
            
            <div class="grid">
                <div class="col-12 md:col-6">
                    <label class="block text-900 font-medium mb-2">Formation Name</label>
                    <input 
                        *ngIf="editMode"
                        type="text" 
                        pInputText 
                        [(ngModel)]="editFormation.name" 
                        class="w-full" />
                    <p *ngIf="!editMode" class="text-900">{{ formation.name }}</p>
                </div>
                
                <div class="col-12 md:col-6">
                    <label class="block text-900 font-medium mb-2">Status</label>
                    <p-tag 
                        [value]="getStatusLabel(formation.status)" 
                        [severity]="getStatusSeverity(formation.status)">
                    </p-tag>
                </div>
                
                <div class="col-12">
                    <label class="block text-900 font-medium mb-2">Description</label>
                    <textarea 
                        *ngIf="editMode"
                        pInputTextarea 
                        [(ngModel)]="editFormation.description" 
                        rows="3" 
                        class="w-full">
                    </textarea>
                    <p *ngIf="!editMode" class="text-900">{{ formation.description }}</p>
                </div>
                
                <div class="col-12 md:col-6">
                    <label class="block text-900 font-medium mb-2">Date & Time</label>
                    <p class="text-900">{{ formatDate(formation.date) }}</p>
                </div>
                
                <div class="col-12 md:col-6">
                    <label class="block text-900 font-medium mb-2">Duration</label>
                    <p class="text-900">{{ formation.duree }} hours</p>
                </div>
                
                <div class="col-12 md:col-6">
                    <label class="block text-900 font-medium mb-2">Room</label>
                    <input 
                        *ngIf="editMode"
                        type="text" 
                        pInputText 
                        [(ngModel)]="editFormation.room" 
                        class="w-full" />
                    <p *ngIf="!editMode" class="text-900">{{ formation.room }}</p>
                </div>
                
                <div class="col-12 md:col-6">
                    <label class="block text-900 font-medium mb-2">Participants</label>
                    <p class="text-900">{{ formation.participantCount }} registered</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-12 lg:col-4">
        <div class="card">
            <h5>Quick Actions</h5>
            <div class="flex flex-column gap-3">
                <p-button 
                    label="Take Attendance" 
                    icon="pi pi-check-square" 
                    class="w-full"
                    [disabled]="formation.status !== 'ongoing' && formation.status !== 'upcoming'"
                    (click)="navigateToAttendance()">
                </p-button>
                <p-button
                    label="Upload Documents"
                    icon="pi pi-upload"
                    class="w-full p-button-outlined"
                    (click)="uploadDocuments()">
                </p-button>
                <p-button
                    label="Send Notification"
                    icon="pi pi-send"
                    class="w-full p-button-outlined"
                    [disabled]="formation.status === 'completed' || formation.status === 'cancelled'"
                    (click)="sendNotification()">
                </p-button>
            </div>
        </div>

        <!-- Formation Stats -->
        <div class="card mt-3" *ngIf="formation.status === 'completed'">
            <h5>Formation Statistics</h5>
            <div class="flex flex-column gap-3">
                <div class="flex justify-content-between align-items-center">
                    <span class="text-600">Attendance Rate</span>
                    <span class="font-semibold">{{ formation.attendanceRate }}%</span>
                </div>
                <p-progressBar [value]="formation.attendanceRate"></p-progressBar>
                
                <div class="flex justify-content-between align-items-center">
                    <span class="text-600">Total Participants</span>
                    <span class="font-semibold">{{ formation.participantCount }}</span>
                </div>
                
                <div class="flex justify-content-between align-items-center">
                    <span class="text-600">Present</span>
                    <span class="font-semibold text-green-500">
                        {{ Math.round(((formation.attendanceRate || 0) / 100) * (formation.participantCount || 0)) }}
                    </span>
                </div>
                
                <div class="flex justify-content-between align-items-center">
                    <span class="text-600">Absent</span>
                    <span class="font-semibold text-red-500">
                        {{ (formation.participantCount || 0) - Math.round(((formation.attendanceRate || 0) / 100) * (formation.participantCount || 0)) }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Participants List -->
    <div class="col-12">
        <div class="card">
            <div class="flex justify-content-between align-items-center mb-4">
                <h5>Participants ({{ participants.length }})</h5>
                <p-button 
                    icon="pi pi-refresh" 
                    class="p-button-rounded p-button-text"
                    (click)="loadParticipants(formation.id)">
                </p-button>
            </div>

            <div *ngIf="loadingParticipants" class="text-center py-3">
                <p-progressSpinner strokeWidth="4"></p-progressSpinner>
            </div>

            <div *ngIf="!loadingParticipants && participants.length === 0" class="text-center py-5">
                <i class="pi pi-users text-4xl text-500 mb-3"></i>
                <p class="text-500">No participants registered</p>
            </div>

            <div *ngIf="!loadingParticipants && participants.length > 0" class="grid">
                <div class="col-12 md:col-6 lg:col-4" *ngFor="let participant of participants">
                    <div class="border-1 surface-border border-round p-3">
                        <div class="flex justify-content-between align-items-start mb-2">
                            <div class="flex align-items-center">
                                <div class="bg-primary-100 text-primary-900 border-circle w-3rem h-3rem flex align-items-center justify-content-center mr-3">
                                    <i class="pi pi-user text-xl"></i>
                                </div>
                                <div>
                                    <div class="font-medium text-900">
                                        {{ participant.user?.first_name }} {{ participant.user?.last_name }}
                                    </div>
                                    <div class="text-500 text-sm">{{ participant.user?.email }}</div>
                                </div>
                            </div>
                            <p-tag 
                                [value]="participant.status" 
                                [severity]="getParticipantStatusSeverity(participant.status)"
                                class="text-xs">
                            </p-tag>
                        </div>
                        
                        <div class="text-500 text-sm">
                            <i class="pi pi-sitemap mr-2"></i>
                            {{ participant.user?.team?.name }}
                        </div>
                        
                        <div *ngIf="formation.status === 'completed' && participant.attendance" 
                             class="mt-2">
                            <p-tag 
                                [value]="participant.attendance === 'present' ? 'Present' : 'Absent'" 
                                [severity]="participant.attendance === 'present' ? 'success' : 'danger'"
                                class="text-xs">
                            </p-tag>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading State -->
<div *ngIf="loading" class="flex justify-content-center align-items-center" style="height: 50vh;">
    <div class="text-center">
        <p-progressSpinner strokeWidth="4"></p-progressSpinner>
        <p class="text-500 mt-3">Loading formation details...</p>
    </div>
</div>

<!-- Send Notification Dialog -->
<p-dialog
    header="Send Notification"
    [(visible)]="notificationDialog"
    [modal]="true"
    [style]="{width: '50vw'}"
    [closable]="true">

    <div class="grid">
        <div class="col-12">
            <label for="notificationSubject" class="block text-900 font-medium mb-2">Subject</label>
            <input
                id="notificationSubject"
                type="text"
                pInputText
                [(ngModel)]="notificationSubject"
                class="w-full"
                placeholder="Enter notification subject">
        </div>

        <div class="col-12">
            <label for="notificationRecipients" class="block text-900 font-medium mb-2">Recipients</label>
            <p-dropdown
                id="notificationRecipients"
                [(ngModel)]="notificationRecipients"
                [options]="[
                    {label: 'All Participants', value: 'all'},
                    {label: 'Registered Participants Only', value: 'registered'},
                    {label: 'Absent Participants Only', value: 'absent'}
                ]"
                optionLabel="label"
                optionValue="value"
                class="w-full">
            </p-dropdown>
        </div>

        <div class="col-12">
            <label for="notificationMessage" class="block text-900 font-medium mb-2">Message</label>
            <textarea
                id="notificationMessage"
                pInputTextarea
                [(ngModel)]="notificationMessage"
                rows="5"
                class="w-full"
                placeholder="Enter your notification message...">
            </textarea>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button
            label="Cancel"
            icon="pi pi-times"
            class="p-button-text"
            (click)="notificationDialog = false">
        </p-button>
        <p-button
            label="Send Notification"
            icon="pi pi-send"
            [disabled]="!notificationSubject || !notificationMessage"
            (click)="sendNotificationMessage()">
        </p-button>
    </ng-template>
</p-dialog>

<!-- Upload Documents Dialog -->
<p-dialog
    header="Upload Documents"
    [(visible)]="uploadDialog"
    [modal]="true"
    [style]="{width: '50vw'}"
    [closable]="true">

    <ng-template pTemplate="content">
        <div class="grid">
            <div class="col-12">
                <label class="block text-900 font-medium mb-2">Formation</label>
                <input
                    type="text"
                    pInputText
                    [(ngModel)]="uploadFormation"
                    placeholder="Formation name"
                    class="w-full"
                    readonly />
            </div>

            <div class="col-12">
                <label class="block text-900 font-medium mb-2">Description (Optional)</label>
                <textarea
                    pInputTextarea
                    [(ngModel)]="uploadDescription"
                    rows="3"
                    placeholder="Enter document description"
                    class="w-full">
                </textarea>
            </div>

            <div class="col-12">
                <label class="block text-900 font-medium mb-2">Files</label>
                <p-fileUpload
                    #fileUpload
                    mode="advanced"
                    [multiple]="true"
                    accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.zip,.rar"
                    [maxFileSize]="10000000"
                    (onSelect)="onFileSelect($event)"
                    (onClear)="clearFiles()"
                    [auto]="false"
                    chooseLabel="Choose Files"
                    uploadLabel="Upload"
                    cancelLabel="Clear"
                    [showUploadButton]="false"
                    [showCancelButton]="true">
                </p-fileUpload>

                <!-- Selected Files Display -->
                <div *ngIf="selectedFiles.length > 0" class="mt-3">
                    <h6 class="text-900 mb-2">Selected Files ({{ selectedFiles.length }}):</h6>
                    <div class="flex flex-column gap-2">
                        <div *ngFor="let file of selectedFiles" class="flex align-items-center gap-2 p-2 border-1 border-300 border-round">
                            <i class="pi pi-file text-primary"></i>
                            <span class="flex-1">{{ file.name }}</span>
                            <small class="text-500">{{ (file.size / 1024 / 1024).toFixed(2) }} MB</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </ng-template>

    <ng-template pTemplate="footer">
        <p-button
            label="Cancel"
            icon="pi pi-times"
            class="p-button-text"
            (click)="cancelUpload()">
        </p-button>
        <p-button
            label="Upload"
            icon="pi pi-upload"
            [disabled]="selectedFiles.length === 0"
            (click)="performUpload()">
        </p-button>
    </ng-template>
</p-dialog>

<p-toast></p-toast>
